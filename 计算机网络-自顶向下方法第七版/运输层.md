
# 运输层


网络层提供了主机之间的**逻辑通信（logic communication）**，而运输层为运行在不同主机上的进程之间提供了**逻辑通信**。

运输层协议只工作在端系统（end system）中。在端系统中，运输层协议将来自应用进程的报文移动到网络边缘（即网络层），反过来也是一样，但对有关这些报文在网络核心如何移动并不作任何规定。

### 多路复用和多路分解
UDP和TCP最基本的责任是，将两个**端系统间IP的交付服务**扩展为运行在端系统上的两个**进程之间的交付服务**。将主机间交付扩展到进程间交付被称为运输层的多路复用 (transport-layer multiplexing)与多路分解(demultiplexing) 。

运输层的多路复用与多路分解，也就是将由网络层提供的主机到主机交付服务延伸到为运行在主机上的应用程序提供进程到进程的交付服务。

多路复用与多路分解服务是所有计算机网络都需要的。

将运输层报文段中的数据交付到正确的套接字的工作称为多路分解(demultiplexing) 在源主机从不同套接字中收集数据块，并为每个数据块封装上首部信息(这将在以后用于分解)从而生成报文段，然后将报文段传递到网络层，所有这些工作称为多路复用(multiplexing) 值。

多路复用要求：①套接字有唯一标识符；②每个报文段有特殊字段来指示该报文段所要交付到的套接字。（这些特殊
字段是源端口号字段(source port number field)和目的端口号字段(destination port number field)
![](/计算机网络-自顶向下方法第七版/image/两个客户使用相同的目的端口号（80）与同一个Web服务器应用通信.png)


### UDP

UDP只做运输协议能够做的最少工作。除了复用/分解功能及少量的差错检测外，它几乎没有对IP增加别的东西。

优点：
1. 应用层可精细控制发送时机，无拥塞控制
2. 无连接建立：发送方和接收方的运输层实体之间没有握手（比如TCP的三次握手）就能互发报文段。
3. 无连接状态：
4. 分组首部开销少：每个TCP报文段都有20字节的首部开销，而UDP仅有8字节的开销。

应用层协议自实现可靠性：
谷歌的Chrome浏览器中的QUIC协议

结构：UDP首部只有4个字段，每个字段由两个字节组成。（源端口号、目的端口号、长度、检验和


### 可靠数据传输原理

可靠数据传输协议（reliable data transfer protocol）：


自动重传请求(Automatic Repeat reQuest, ARQ)协议：有三种协议功能用于检查存在比特差错的情况。
1. 差错检测：使用差错检测和纠错技术检测并可能纠正分组中的比特差错
2. 接收方反馈：接收方提供明确的反馈信息给发送方的"肯定确认"(ACK)和"否定确认"(NAK)
3. 重传：接收方收到有差错的分组时，发送方将重传该分组文

ACK: positive acknowledgment 肯定确认
NAK: negative acknowledgment 否认确定

分组重传发生情况：分组丢失、分组受损，校验出错、收到应答超时

停等(stop and-wait)协议：当发送方处于等待ACK或NAK的状态时，发送方将不会发送一块新数据，除非发送方确信接收方已正确接收当前分组，具有这种行为的协议。

发送方发送多个分组而无须等待确认，这种技术被称为流水线（pipelining），这种技术会带来更大的挑战是数据传输协议如何处理丢失、损坏及延时过大的分组。解决流水线的差错恢复有两种基本方法是：回退/V步（Go Back N, GBN）和选择重传(Selective Repeat, SR)

回退N步：允许发送方发送多个分组（当有多个分组可用时）而不需等待确认，但它也受限于在流水线中未确认的分组数不能超过某个最大允许数N。

![](/计算机网络-自顶向下方法第七版/image/在GBN中发送方看到的序号.png)
如上图那些已被发送但还未被确认的分组的许可序号范围可以被看成是一个在序号范围内长度为N的窗口。随着协议的运行，该窗口在序号空间向前滑动。因此，N常被称为窗口长度（window size） , GBN协议也常被称为滑动窗口协议（sliding-window protocol）。

GBN发送方必须响应三种类型的事件：
1. 上层的调用：发送方检查发送窗口是否已满，如果未满，则产生一个分组并将其发送，并相应地更新变量。如果已满，发送方将数据告知上层该窗口已满。然后上层可能会过一会儿再试。
2. 收到一个ACK：GBN协议中使用累计确认：cumulative acknowledgment 表明接收方已正确接收到序号为n的以前包括n在内的所有分组。
3. 超时事件：如果出现超时，发送方重传所有已发送但还未被确认过的分组。








### TCP


运输协议也能为应用程序提供可靠安全的数据传输服务。

TCP为应用程序提供了几种附加服务。首先，它提供可靠数据传输(reliableble data transfer)通过使用流量控制、序号、确认和定时器。

拥塞控制(congestion control)：拥塞控制与其说是一种提供给调用它的应用程序的服务，不如说是一种
提供给整个因特网的服务，这是一种带来通用好处的服务。不太严格地说，TCP拥塞控制防止任何一条TCP连接用过多流量来淹没通信主机之间的链路和交换设备。TCP力求为每个通过一条拥塞网络链路的连接平等地共享网络链路带宽。



